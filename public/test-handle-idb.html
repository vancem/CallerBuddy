<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FileSystemHandle + IndexedDB Test</title>
  <style>
    body { font-family: system-ui; padding: 1rem; max-width: 480px; margin: 0 auto; }
    button { display: block; margin: 0.5rem 0; padding: 0.5rem 1rem; font-size: 1rem; }
    pre { background: #f0f0f0; padding: 0.5rem; overflow-x: auto; font-size: 0.85rem; }
    .pass { color: green; }
    .fail { color: red; }
    .info { color: #666; }
  </style>
</head>
<body>
  <h1>FileSystemHandle + IndexedDB Test</h1>
  <p class="info">Tests whether storing a FileSystemDirectoryHandle in IndexedDB works on this device/browser. Use on Android to confirm persistence.</p>

  <button id="store">1. Pick folder & store in IndexedDB</button>
  <button id="load">2. Load from IndexedDB & verify</button>
  <button id="clear">Clear stored handle</button>

  <h2>Log</h2>
  <pre id="log"></pre>

  <script>
    const IDB_NAME = "test-handle-idb";
    const IDB_STORE = "handles";
    const IDB_KEY = "root";

    const logEl = document.getElementById("log");
    function log(msg, cls = "") {
      const line = document.createElement("div");
      line.className = cls;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = () => {
          if (!req.result.objectStoreNames.contains(IDB_STORE)) {
            req.result.createObjectStore(IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    document.getElementById("store").onclick = async () => {
      if (typeof window.showDirectoryPicker !== "function") {
        log("FAIL: showDirectoryPicker not supported", "fail");
        return;
      }
      try {
        log("Opening directory pickerâ€¦");
        const handle = await window.showDirectoryPicker({ mode: "readwrite" });
        log(`Picked: ${handle.name}`);

        const db = await openDB();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readwrite");
          tx.objectStore(IDB_STORE).put(handle, IDB_KEY);
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
        log("PASS: Handle stored in IndexedDB", "pass");
      } catch (err) {
        log(`FAIL: ${err.message}`, "fail");
      }
    };

    document.getElementById("load").onclick = async () => {
      try {
        const db = await openDB();
        const handle = await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readonly");
          const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
          req.onsuccess = () => { db.close(); resolve(req.result); };
          req.onerror = () => { db.close(); reject(req.error); };
        });

        if (!handle) {
          log("FAIL: No handle in IndexedDB (run step 1 first, then navigate away and back)", "fail");
          return;
        }

        log(`Loaded handle: ${handle.name}`);
        log(`Is FileSystemDirectoryHandle? ${handle instanceof FileSystemDirectoryHandle}`);

        const perm = await handle.queryPermission({ mode: "readwrite" });
        log(`Permission: ${perm}`);

        if (perm === "granted") {
          const entries = [];
          for await (const e of handle.values()) entries.push(e.name);
          log(`Can list dir: ${entries.length} entries`);
          log("PASS: Handle works after load", "pass");
        } else {
          log("Handle loaded but permission not granted (may need user gesture to request)", "info");
        }
      } catch (err) {
        log(`FAIL: ${err.message}`, "fail");
      }
    };

    document.getElementById("clear").onclick = async () => {
      const db = await openDB();
      await new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readwrite");
        tx.objectStore(IDB_STORE).delete(IDB_KEY);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
      log("Cleared stored handle");
    };
  </script>
</body>
</html>
